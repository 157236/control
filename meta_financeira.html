<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meta Financeira</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-5">
        <h1>Meta Financeira</h1>
        <form id="metaForm" class="mt-3 ">
            <div class="mb-3">
                <label for="meta" class="form-label">Meta:</label>
                <input type="number" id="meta" name="meta" class="form-control" required>
            </div>
            <div class="mb-3">
                <label for="descricao" class="form-label">Descrição:</label>
                <input type="text" id="descricao" name="descricao" class="form-control" required>
            </div>
            <div class="mb-3">
                <label for="dataInicial" class="form-label">Data Inicial:</label>
                <input type="date" id="dataInicial" name="dataInicial" class="form-control" required>
            </div>
            <div class="mb-3">
                <label for="dataFinal" class="form-label">Data Final:</label>
                <input type="date" id="dataFinal" name="dataFinal" class="form-control" required>
            </div>
            <button type="submit" class="btn btn-primary">Criar Meta</button>
        </form>
        <!--Adicionar um espaçamento de uns 200px antes do gráfico aparecer-->
        <div class="mt-3" id="alertContainer"></div>
        <div class="row mt-5">
            <div class="col">
                <h2>Aportes Mensais</h2>
                <div class="mb-3">
                    <label for="aporteMensal" class="form-label">Aporte Mensal:</label>
                    <input type="number" id="aporteMensal" class="form-control" required>
                </div>
                <div class="mb-3">
                    <label for="mesAporte" class="form-label">Mês do Aporte:</label>
                    <select id="mesAporte" class="form-select">
                        <option value="1">Janeiro</option>
                        <option value="2">Fevereiro</option>
                        <option value="3">Março</option>
                        <option value="4">Abril</option>
                        <option value="5">Maio</option>
                        <option value="6">Junho</option>
                        <option value="7">Julho</option>
                        <option value="8">Agosto</option>
                        <option value="9">Setembro</option>
                        <option value="10">Outubro</option>
                        <option value="11">Novembro</option>
                        <option value="12">Dezembro</option>
                    </select>
                </div>
                <button id="adicionarAporte" class="btn btn-success">Adicionar Aporte</button>
            </div>
            <div class="col">
                <h2>Simulação</h2>
                <div class="mb-3">
                    <label for="simulacao" class="form-label">Fazer Simulação:</label>
                    <input type="number" id="simulacao" class="form-control" placeholder="Fazer simulação">
                </div>
                <div class="mb-3">
                    <label for="dataInicialSimulacao" class="form-label">Data Inicial:</label>
                    <input type="date" id="dataInicialSimulacao" class="form-control">
                </div>
                <div class="mb-3">
                    <label for="dataFinalSimulacao" class="form-label">Data Final:</label>
                    <input type="date" id="dataFinalSimulacao" class="form-control">
                </div>
                <button id="simular" class="btn btn-warning">Simular</button>
            </div>
        </div>
        <div class="mt-5" id="chartContainer" style="height: 300px;"></div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <script>
        let meta = 0;
        let descricao = "";
        let dataInicial = null;
        let dataFinal = null;
        let chart = null;
        let simulacaoValor = null;
        let dataInicialSimulacao = null;
        let dataFinalSimulacao = null;

        document.addEventListener('DOMContentLoaded', function () {
            const form = document.getElementById('metaForm');
            form.addEventListener('submit', function (event) {
                event.preventDefault();
                meta = parseFloat(document.getElementById('meta').value);
                descricao = document.getElementById('descricao').value;
                dataInicial = new Date(document.getElementById('dataInicial').value);
                dataFinal = new Date(document.getElementById('dataFinal').value);
                renderChart();
                showAlert('success', `Meta criada para ${descricao}`);
                form.reset();
            });

            const adicionarAporteBtn = document.getElementById('adicionarAporte');
            adicionarAporteBtn.addEventListener('click', function () {
                const aporte = parseFloat(document.getElementById('aporteMensal').value);
                const mesAporte = parseInt(document.getElementById('mesAporte').value);
                renderChart(aporte, mesAporte);
                document.getElementById('aporteMensal').value = "";
            });

            const simularBtn = document.getElementById('simular');
            simularBtn.addEventListener('click', function () {
                simulacaoValor = parseFloat(document.getElementById('simulacao').value);
                dataInicialSimulacao = new Date(document.getElementById('dataInicialSimulacao').value);
                dataFinalSimulacao = new Date(document.getElementById('dataFinalSimulacao').value);
                renderChart();
            });
        });

        function renderChart(aporte = 0, mesAporte = 1) {
            if (!dataInicial || !dataFinal || !meta) {
                return;
            }

            const meses = [];
            const valoresMeta = [];
            const valoresAporte = [];
            const valoresSimulacao = [];

            let totalSimulacao = 0;
            let valorSimulacaoAtual = simulacaoValor;

            for (let d = new Date(dataInicial); d <= dataFinal; d.setMonth(d.getMonth() + 1)) {
                meses.push(`${d.getMonth() + 1}/${d.getFullYear()}`);
                valoresMeta.push(meta);
                valoresAporte.push(d.getMonth() + 1 === mesAporte ? aporte : 0);

                if (d >= dataInicialSimulacao && d <= dataFinalSimulacao) {
                    valoresSimulacao.push(valorSimulacaoAtual);
                    totalSimulacao += valorSimulacaoAtual;
                    valorSimulacaoAtual += simulacaoValor;
                } else {
                    valoresSimulacao.push(0);
                }
            }

            if (chart) {
                chart.destroy();
            }

            const chartOptions = {
                chart: {
                    type: 'bar'
                },
                series: [{
                    name: 'Meta Financeira',
                    data: valoresMeta
                }, {
                    name: 'Aporte Mensal',
                    data: valoresAporte
                }, {
                    name: 'Simulação',
                    data: valoresSimulacao
                }],
                xaxis: {
                    categories: meses
                }
            };

            chart = new ApexCharts(document.getElementById('chartContainer'), chartOptions);
            chart.render();

            showAlert('info', `Valor total da simulação ao final do período: ${totalSimulacao}`);
        }

        function showAlert(type, message) {
            const alertContainer = document.getElementById('alertContainer');
            alertContainer.innerHTML = `
                <div class="alert alert-${type}" role="alert">
                    ${message}
                </div>
            `;
        }
        
    </script>
</body>
</html>
